<!--
  I'm no good with setting up infrastructure from scratch
  Usually using ready to go examples that just work (either from tutorials or documentation)
  In this instance using the code from: http://jsfiddle.net/25g06zbb/3/
-->

<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/2.2.1/jasmine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/2.2.1/jasmine-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/2.2.1/boot.min.js"></script>
    <script src="https://code.angularjs.org/1.3.9/angular.min.js"></script>
    <script src="https://code.angularjs.org/1.3.9/angular-mocks.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jasmine/2.2.1/jasmine.min.css">
  </head>
  <body>

    <script>
(function (app) {

    app.factory("oDataSvc", ['$q', '$http', function ($q, $http) {
        return {
            checkEndPoint: function () {
                var deferred = $q.defer();
                $http.get("http://services.odata.org/V4/TripPinServiceRW")
                    .then(function () {
                    deferred.resolve(true);
                }, function () {
                    deferred.resolve(false);
                });
                return deferred.promise;
            }
        };
    }]);

})(angular.module('test', []));

(function () {

    var url = "http://services.odata.org/V4/TripPinServiceRW";

    describe("jasmine", function () {
        it("works", function () {
            expect(true).toBe(true);
        });
    });

    describe("angular unit test", function () {

        var oDataService, httpBackend;

        beforeEach(function () {
            module("test");
        });

        beforeEach(inject(function ($httpBackend, oDataSvc) {
            httpBackend = $httpBackend;
            oDataService = oDataSvc;
        }));

        afterEach(function () {
            httpBackend.verifyNoOutstandingExpectation();
            httpBackend.verifyNoOutstandingRequest();
        });

        it("is registered with the module.", function () {
            expect(oDataService).not.toBeNull();
        });

        describe("checkEndPoint", function () {

            it("should return true upon successful connection", function () {
                oDataService.checkEndPoint()
                    .then(function (result) {
                    expect(result).toEqual(true);
                }, function () {
                    expect(false).toBe(true);
                });
                httpBackend.expectGET(url).respond(200, null);
                httpBackend.flush();
            });
            
            it("should return false upon failed connection", function () {
                oDataService.checkEndPoint()
                    .then(function (result) {
                    expect(result).toEqual(false);
                }, function () {
                    expect(false).toBe(true);
                });
                httpBackend.expectGET(url).respond(500, null);
                httpBackend.flush();
            });
        });
    });
    
    describe("angular integration test", function () {

        var oDataService, http, flush;

        beforeEach(function () {
            var i = angular.injector(["ng"]), rs = i.get("$rootScope");
            http = i.get("$http");
            
            flush = function () {
                rs.$apply();
            }
            
            module("test", function ($provide) {
                $provide.value("$http", http); 
                $provide.value("$rootScope", rs);
            });
        });

        beforeEach(inject(function (oDataSvc) {
            oDataService = oDataSvc;
        }));

        it("is registered with the module.", function () {
            expect(oDataService).not.toBeNull();
        });

        describe("checkEndPoint", function () {

            it("should return true to verify the service is up", function (done) {
                oDataService.checkEndPoint()
                    .then(function (result) {
                    expect(result).toEqual(true);
                        done();
                }, function () {
                    expect(false).toBe(true);
                    done();
                });
                flush();
            });
        });
    });

})();

    </script>


  </body>
</html>